---
title: "Prepare ProPublica data"
author: 
  - "Cole Tanigawa-Lau"
date: ""
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float: yes
    theme: paper
editor_options:
  chunk_output_type: console
params: 
  from_raw: FALSE
  dev:   FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 7, fig.height = 5)
proj_dir <- tryCatch(rprojroot::find_rstudio_root_file(),
                     error = function(e) rprojroot::find_root(".gitignore"))

knitr::opts_knit$set(root.dir = proj_dir)
```

```{r about, echo=FALSE, results = "asis"}
cat(
    sprintf("Updated: %s.", 
            format(Sys.time(), "%b %d, %Y at %H:%M:%S", usetz = TRUE)),
    sprintf("Working directory: `%s`.", getwd()),
    sep = "\n\n"
)
```

This document organizes the ProPublica data on congressional legislation. 

There are dev packages like `rsunlight` to query the ProPublica and OpenStates APIs. They aren't reliable and don't permit bulk downloads. It's easiest to bypass query limits and click-download from links.

Source: https://www.propublica.org/datastore/dataset/congressional-data-bulk-legislation-bills

Data documentation: https://github-wiki-see.page/m/unitedstates/congress/wiki/Bills


Reads:

  - ~Adams mapping from CRS codes to topics: data/topic_labels/label_codings.csv~
   
    - Adam didn't include the 24 more general topics
   
  - Congressional Bills Project codings: data/topic_labels/bills93-114.csv
  - Legislation: zip files in data/legislation/propublica
  - Legislator ID codes: data/congress_ids.csv

Writes:

- Bill metadata + topics: data/legislation/propublica/bills_list.qs
- Bill-legislator sponsorship with FEC IDs: data/legislation/propublica/sponsorship.qs

# Setup

```{r packages, warning=FALSE, message=FALSE}
tictoc::tic()
rm(list = setdiff(ls(), "params"))

library(fst)
library(qs)
library(stringr)
library(data.table)
library(jsonify)
library(purrr)
library(furrr)
library(coler)
library(dplyr)
library(tidyr)
library(tidylog)

source("code/functions.R")

if(!exists("params")) params <- list(dev = interactive())
if(params$dev) plan(multisession) else plan(multicore)
```

```{r}
cbp_bills <- fread("data/topic_labels/bills93-114.csv")

# Clicked links here from 1999-present:
# https://www.propublica.org/datastore/dataset/congressional-data-bulk-legislation-bills
# Then moved them to propublica subdir
pp_dir <- "data/legislation/propublica"
```

Unzip bulk data files.
```{r unzip, eval = params$from_raw}
# Find files not marked as unzipped
zips <- list.files(pp_dir, patt = "[0-9]\\.zip", full = TRUE, recursive = FALSE)
names(zips) <- gsub("\\.zip", "", zips)


map(names(zips), dir.create)

future_map(names(zips),
           function(nm) { 
               
               unzip(zips[[nm]], exdir = nm); 
               
               # Mark as unzipped
               zips[[nm]] %>% 
               { file.rename(., gsub(".zip", "unz.zip", x = ., fixed = TRUE)) }
           }
)
```

Read in the JSON files and store as R lists.
```{r qsave_jsons, eval = params$from_raw}
sessions <- 106:116
pp_read_dirs <- file.path(pp_dir, sessions)

pp_paths <-
    future_map(pp_read_dirs, list.files, 
               recursive = TRUE, full.names = TRUE,
               pattern = ".json") %>% 
    unlist()

qsave(pp_paths, "data/legislation/propublica/pp_paths.qs")
pp_paths <- qread("data/legislation/propublica/pp_paths.qs")

bills_jslist <- 
    future_map(pp_paths, from_json, simplify = TRUE, fill_na = TRUE)
qsave(bills_jslist, "data/legislation/propublica/pp_bills_jslist.qs")
```

Standardize bills and amendments data into an R object.

```{r json_to_bill, eval = params$from_raw}
bills_jslist <- 
    qread("data/legislation/propublica/pp_bills_jslist.qs")

bill_ids  <- map(bills_jslist, "bill_id")

system.time(bills <- map(bills_jslist, jslist_to_bill))
#     user   system  elapsed 
# 1145.487   25.995 1202.459 
names(bills) <- map(bills, "bill_id")

qsave(bills, "data/legislation/propublica/bills_list.qs")
```


# Link legislation to topics

Recode the Congressional Bills Project data to include major topic tags. These were hand-coded for the single most important topic. Codebook is in Excel format and does not report why there are legislator-specific variables for a bill-level data set.

```{r}
cbp_topics <- 
  select(cbp_bills,
         bill_id = BillID, senate = Chamber, congress = Cong,
         num_cospons = Cosponsr, major = Major, minor = Minor,
         private = Private,
         pass_house = PassH, pass_senate = PassS, veto = Veto,
         # passed and signed into law
         ps_law = PLaw, party_majority = Majority) %>% 
  
  left_join(AgendasProjectTopicCodes, 
            by = c(major = "code_major"))

table(cbp_topics$topic_major, useNA = "always") %>% 
  sort()
```

```{r}
bills <- qread("data/legislation/propublica/bills_list.qs")
topics_list <- map(bills, "topics")

cbp_topics[ , 
              GET: gsub(",3})-([A-Z]*)-(\\d*)", 
            bill_id_pp := 
                   "\\2\\3-\\1",
                   bill_id) %>% tolower()
            ]

# check
# cbp_topics[sample(.N, 20), .(bill_id, bill_id_pp)]
# sample(bills %>% names(), 20)
```

Keyed data.table lookup to grab hand-coded topic labels from Congressional Bills Project data set and add them to ProPublica list of bills.
```{r add_cbp_topics}
setkey(cbp_topics, "bill_id_pp")

for(bill in bills)
  bill$topics$cbp_topic <- cbp_topics[bill$topics$bill_id, topic_major]
```

# Query for full bill text

Convert to a data.frame of bills with CBP topics. Dropping sponsorship data for now.
```{r}
bill_topic_text <- 
  map(bills,
      ~ data.table(bill_id   = .x$topics$bill_id,
                   topic_cbp = .x$topics$cbp_topic,
                   topic_crs = .x$topics$primary_topic,
                   summary   = .x$topics$summary)
      ) %>% 
  rbindlist()
```

```{r}
# Base URL: legislation.nysenate.gov/api/3/bills/2015/S1?key=*your key goes here*
# GET: "/api/3/bills/{sessionYear}"
# GET: "/api/3/bills/{{sessionYear}}/{{printNo}}?view=only_fulltext"
bill_topic_text$bill_id %>% head()
```


<!-- Using Adam's CRS-to-topic mapping. In the future, I think it might be a good idea to map to the Policy Agenda Project's issue codings. These are also used in Baumgartner et al. (2014)'s study of lobbying. -->

```{r}
cbp_topics %>% head()
sponsorship$bill_id %>% head()

# setDT(bonica_labels, key = "V1")
# subj_tags[ , tag := as.character(tag)]

# topic <- "legislative"
# subjects <- sponsorship$bill_subjects[[3]]

# Create data.table of topic columns to fill
topic_cols <- sponsorship[ , .(bill_id = unique(bill_id))]

uniq_topics <- unique(bonica_labels$type)
for(topic in uniq_topics) set(topic_cols, j = topic, value = 0)

map(topics_list,
    function(bill) {
        # Get vector of bill subjects
        cols <- subj_tags[bill$subjects, na.omit(unique(tag))]
        # Locate bill in topics DF by ID
        ind <- which(topic_cols$bill_id == bill$bill_id)
        for(topic in cols) set(topic_cols, i = ind, j = topic, 
                               value = topic_cols[[topic]][ind] + 1)
    }
)
```


# Final cleaning
```{r}
sponsorship[ ,
             `:=`(
               congress = str_extract(bill_id, "\\d+$"),
               # Names for fuzzy join with DIME.
               fname = tolower(fname) %>% gsub("[[:punct:]]", " ", .) %>% 
                 gsub("\\s+", " ", .) %>% str_trim(),
               lname = tolower(lname) %>% gsub("[[:punct:]]", " ", .) %>% 
                 gsub("\\s+", " ", .) %>% str_trim()
               )
             ]

congr_yr <- 
  data.table(congress = as.character(117:80),
             elec_year = seq(2020, 1946, by = -2) %>% as.character())

sponsorship[congr_yr, 
            cycle := i.elec_year,
            on = "congress"]
```

```{r include = FALSE}
qsave(sponsorship, "data/legislation/propublica/spons_dev.qs")
sponsorship <- qread("data/legislation/propublica/spons_dev.qs")
```

# Expand to include non-sponsor rows

Create a complete legislator identifier.
```{r}
sponsorship[ , pid := ifelse(is.na(bioguide_id), thomas_id, bioguide_id)]
stopifnot(mean(is.na(sponsorship$pid)) < 0.001)

sponsorship[ , bill_subjects := NULL]
```

```{r eval = FALSE}
# 10% downsample for dev
legis_samp <- sponsorship[ , unique(pid) %>% sample(., length(.)/10)]
sponsorship <- filter(sponsorship, pid %in% legis_samp)
```


Observations imply sponsorship. Reformat to a data set with a column indicating sponsorship.
```{r prep_expand}
sponsorship[ , sponsored := 1L]

# Expand to include non-sponsorship
spons_expand <- 
  group_by(sponsorship, cycle) %>% 
  expand(bill_id, pid)

# # Data set of legislators' sponsorship for every bill in each cycle
# base_bill <- 
#   unique(sponsorship[ , .SD, 
#                       .SDcols = c("state", uniq_topics),
#                       keyby = .(cycle, bill_id)]
#   )
# base_legis <- 
#   unique(sponsorship[ , .SD, 
#                       .SDcols = c("lname", "fname"),
#                       keyby = .(cycle, bill_id, pid)]
#   )

setDT(sponsorship, key = c("cycle", "bill_id", "pid"))
setDT(spons_expand, key = c("cycle", "bill_id", "pid"))
```

Check reformatting: all legislators have the same number of bill observations per cycle.
```{r check_expand}
chk <- spons_expand[ , .N, by = .(cycle, pid)]

stopifnot(chk[ , between(N, 1e4, 2e4)] %>% all())
for(yr in unique(chk$cycle)) stopifnot(var(dplyr::filter(chk, cycle == yr)$N) == 0)
```

Merge data into observed rows. Fill in unobserved rows later.

```{r expand_merge}
cn <- setdiff(names(sponsorship), names(spons_expand))

spons_expand[sponsorship,
             (cn) := mget(paste0("i.", cn))
             ]
```

That merge was by cycle-bill-legislator (vars like `sponsorship`, `primary`, `withdrawn`), so I need to fill in the data that vary by bill (e.g., topics) and by legislator (e.g., `fname`) individually.

```{r group_fill}
# Fill in missing data by person
person_cn <- c("state", "district", "thomas_id", "bioguide_id", "lname", "fname", "title", "type")

spons_expand <- 
  group_by(spons_expand, cycle, pid) %>% 
  fill(all_of(person_cn), .direction = "downup")

# Fill in missing data by bill
bill_cn <- c(uniq_topics, "num_topics", "congress")

spons_expand <- 
  group_by(spons_expand, cycle, bill_id) %>% 
  fill(all_of(bill_cn), .direction = "downup") %>% 
  mutate(sponsored       = if_else(is.na(sponsored), 0L, sponsored),
         primary         = if_else(is.na(primary), 0L, primary),
         withdrawn       = if_else(is.na(withdrawn), 0L, withdrawn)
         ) %>%
  rename(spons_primary = primary,
         spons_withdrawn = withdrawn,
         bill_title = title, bill_type = type)
```


<!-- Key-merge the data in by reference. Two merges since the data are at different levels, and the non-sponsor rows need their bill topic data filled in. -->


<!-- ```{r expand_merges} -->
<!-- cn <- setdiff(names(base_bill), names(spons_expand)) -->
<!-- spons_expand[base_bill, -->
<!--              (cn) := mget(paste0("i.", cn)), -->
<!--              on = c("cycle", "bill_id")] -->

<!-- cn <- setdiff(names(base_legis), names(spons_expand)) -->
<!-- spons_expand[base_legis, -->
<!--              (cn) := mget(paste0("i.", cn)), -->
<!--              on = c("cycle", "bill_id", "pid")] -->

<!-- spons_expand[ , prop_na(sponsored), by = state] -->
<!-- spons_expand[is.na(sponsored), sponsored := 0L] -->
<!-- ``` -->


# Export
```{r}
write_fst(spons_expand, "data/legislation/propublica/sponsorship.fst")
write_fst(spons_expand %>% sample_n(size = n()),
          "data/legislation/propublica/sponsorship_shuffle.fst")
```


```{r}
tictoc::toc()
```

